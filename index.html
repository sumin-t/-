<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🪐 나만의 행성 그림 만들기 (직접 키 포함)</title>
  <style>
    :root { --bg:#0b1020; --card:#121a33; --text:#eef3ff; --muted:#9fb0ff; --accent:#6ea8ff; --accent-2:#9ee5ff; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:radial-gradient(1200px 800px at 80% -20%, #1b2a6b22, transparent), var(--bg); color:var(--text)}
    header{text-align:center;padding:28px 16px 8px}
    header h1{margin:0;font-size:1.8rem}
    header p{margin:6px 0 0;color:var(--muted)}
    .container{max-width:980px;margin:0 auto;padding:20px 16px 48px}
    .card{background:linear-gradient(180deg,#121a33,#0f1530);border:1px solid #2a335e;border-radius:18px;padding:20px;box-shadow:0 8px 30px #00000044}
    .grid{display:grid;grid-template-columns:1.1fr 1fr;gap:18px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    label{display:block;margin:12px 0 6px;font-weight:600;color:var(--muted)}
    select,textarea,input[type=text]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #334072;background:#0c1330;color:var(--text);outline:none;transition:border .15s ease}
    select:focus,textarea:focus{border-color:var(--accent)}
    textarea{min-height:110px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:600px){.row{grid-template-columns:1fr}}
    .btn{appearance:none;border:0;background:linear-gradient(180deg,var(--accent),#4c87ff);color:#051026;font-weight:800;letter-spacing:.3px;padding:12px 16px;border-radius:14px;cursor:pointer;box-shadow:0 6px 20px #2b54ff55;transition:transform .06s ease,filter .2s ease;width:100%}
    .btn:disabled{filter:grayscale(.7) brightness(.7);cursor:not-allowed}
    .btn:hover:not(:disabled){transform:translateY(-1px)}
    .preview{background:#0a1028;border:1px dashed #30407a;border-radius:16px;min-height:280px;display:grid;place-items:center;overflow:hidden}
    .preview img{width:100%;height:auto;display:block}
    .hint{font-size:.92rem;color:var(--muted)}
    .small{font-size:.86rem;color:#b6c4ff}
    .hidden{display:none}
    .status{margin-top:10px;padding:10px 12px;border-radius:12px;background:#0f1842;border:1px solid #2c3a7a}
    .download{margin-top:10px;display:flex;gap:10px;align-items:center}
    .download a{text-decoration:none;color:var(--accent-2);font-weight:700}
    footer{text-align:center;padding:16px;color:#9db0ff66}
  </style>
</head>
<body>
  <header>
    <h1>🪐 나만의 행성 그림 만들기</h1>
    <p class="small">(내부 전용) 이 버전은 <b>브라우저에서 OpenAI API를 직접 호출</b>합니다. 키가 노출될 수 있으니 공개 배포 금지!</p>
  </header>

  <div class="container">
    <div class="card grid">
      <section>
        <label for="apiKey">OpenAI API 키</label>
        <input id="apiKey" type="password" placeholder="sk-로 시작하는 키를 입력하거나, 아래 KEY 상수에 하드코딩하세요" />

        <label for="planet">행성 선택</label>
        <select id="planet">
          <option value="Mercury" data-style="작고 회색빛, 많은 운석 크레이터, 대기 희박, 태양에 매우 가까움">수성 (Mercury)</option>
          <option value="Venus" data-style="두꺼운 황백색 구름, 매우 뜨거움, 부드러운 광채, 약한 표면 디테일">금성 (Venus)</option>
          <option value="Earth" data-style="푸른 바다, 하얀 구름, 초록과 갈색 대륙, 생명 넘치는 느낌">지구 (Earth)</option>
          <option value="Mars" data-style="적갈색 사막, 거대한 화산과 협곡, 엷은 대기, 먼지폭풍 가능">화성 (Mars)</option>
          <option value="Jupiter" data-style="갈색과 크림색 줄무늬, 거대한 붉은 점 폭풍, 거대 가스행성">목성 (Jupiter)</option>
          <option value="Saturn" data-style="아름다운 고리, 황금빛 가스층, 섬세한 고리 구조 디테일">토성 (Saturn)</option>
          <option value="Uranus" data-style="밝은 청록색, 옅은 구름, 옆으로 누운 자전축, 차분한 느낌">천왕성 (Uranus)</option>
          <option value="Neptune" data-style="진한 파란색, 강한 바람, 어두운 점 폭풍 가능, 차갑고 깊은 바다 느낌">해왕성 (Neptune)</option>
        </select>

        <label for="prompt">프롬프트</label>
        <textarea id="prompt" placeholder="예) 아이들이 바라보는 만화풍, 별빛이 반짝이는 배경, 따뜻한 색감"></textarea>

        <div class="row">
          <div>
            <label for="style">스타일 (선택)</label>
            <select id="style">
              <option value="">자동</option>
              <option>수채화</option>
              <option>만화풍</option>
              <option>픽셀아트</option>
              <option>유화</option>
              <option>리얼리즘</option>
              <option>플랫 일러스트</option>
            </select>
          </div>
          <div>
            <label for="size">이미지 크기</label>
            <select id="size">
              <option>1024x1024</option>
              <option>1024x1792</option>
              <option>1792x1024</option>
            </select>
          </div>
        </div>

        <div style="margin-top:16px; display:flex; gap:10px; align-items:center;">
          <button id="generate" class="btn">그림 만들기</button>
          <span id="spinner" class="small hidden">생성 중입니다…</span>
        </div>

        <div id="status" class="status hidden"></div>
      </section>

      <section>
        <div class="preview" id="preview"><div class="hint">여기에 이미지가 표시됩니다</div></div>
        <div class="download hidden" id="downloadWrap">
          <a id="downloadLink" download>이미지 다운로드</a>
          <span id="meta" class="small"></span>
        </div>
      </section>
    </div>
  </div>

  <script>
    // =========================
    // 🔑 1) 여기 KEY 상수에 직접 넣거나, 페이지 상단 입력란(id=apiKey)에 입력하세요.
    // =========================
    const KEY = ""; // 예: "sk-XXXX..." (비워두면 입력란의 값 사용)

    // 브라우저에서 OpenAI API 호출: CORS 정책이 바뀌면 동작하지 않을 수 있습니다.
    // 문제가 생기면 서버 프록시(/api/generate) 방식을 사용하세요.

    const el = (id) => document.getElementById(id);
    const planetSel = el('planet');
    const promptEl  = el('prompt');
    const styleSel  = el('style');
    const sizeSel   = el('size');
    const genBtn    = el('generate');
    const spinner   = el('spinner');
    const statusBox = el('status');
    const preview   = el('preview');
    const dlWrap    = el('downloadWrap');
    const dlLink    = el('downloadLink');
    const meta      = el('meta');
    const keyInput  = el('apiKey');

    function showStatus(msg, kind='info'){
      statusBox.textContent = msg; statusBox.classList.remove('hidden');
      statusBox.style.background = kind==='err' ? '#3d0d10' : '#0f1842';
      statusBox.style.border = kind==='err' ? '1px solid #c23d45' : '1px solid #2c3a7a';
    }
    function hideStatus(){ statusBox.classList.add('hidden'); }
    function showSpinner(on){ spinner.classList.toggle('hidden', !on); genBtn.disabled = on; }

    function makeFileName(ext){
      const p = (planetSel?.value || 'planet').replace(/\s+/g,'_');
      const ts = new Date().toISOString().replaceAll(':','').replaceAll('-','').slice(0,15);
      return `${p}_${ts}.${ext}`;
    }
    function b64ToBlob(b64, contentType='image/png'){
      const byteChars = atob(b64); const byteArrays=[]; const sliceSize=512;
      for(let offset=0; offset<byteChars.length; offset+=sliceSize){
        const slice = byteChars.slice(offset, offset+sliceSize);
        const nums = new Array(slice.length);
        for(let i=0;i<slice.length;i++) nums[i] = slice.charCodeAt(i);
        byteArrays.push(new Uint8Array(nums));
      }
      return new Blob(byteArrays,{type:contentType});
    }
    function setPreviewFromB64(b64){
      const img = new Image(); img.src = `data:image/png;base64,${b64}`; img.alt='생성된 이미지';
      preview.innerHTML=''; preview.appendChild(img);
      const url = URL.createObjectURL(b64ToBlob(b64));
      dlLink.href = url; dlLink.download = makeFileName('png');
      dlWrap.classList.remove('hidden');
      meta.textContent = new Date().toLocaleString();
    }

    async function callOpenAIImage(prompt, size){
      const apiKey = KEY || keyInput.value.trim();
      if(!apiKey){ throw new Error('API 키가 없습니다. KEY 상수에 넣거나 입력란에 입력하세요.'); }

      const body = { model: 'gpt-image-1', prompt, size, n: 1, response_format: 'b64_json' };

      const res = await fetch('https://api.openai.com/v1/images/generations',{
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${apiKey}` },
        body: JSON.stringify(body)
      });
      if(!res.ok){
        let detail = await res.text();
        throw new Error(`OpenAI 요청 실패 (${res.status}) ${detail}`);
      }
      const data = await res.json();
      const d0 = data?.data?.[0];
      if(d0?.b64_json){ return { b64: d0.b64_json }; }
      if(d0?.url){ return { url: d0.url }; }
      throw new Error('이미지 데이터가 응답에 없습니다.');
    }

    async function generate(){
      hideStatus(); dlWrap.classList.add('hidden');
      const userPrompt = (promptEl.value||'').trim();
      if(!userPrompt){ showStatus('프롬프트를 입력해주세요.','err'); return; }

      const planet = planetSel.value;
      const planetStyle = planetSel.options[planetSel.selectedIndex].dataset.style || '';
      const style = styleSel.value;
      const size = sizeSel.value;

      const styleTag = style ? `, 스타일: ${style}` : '';
      const sys = `친근한 교육용 우주 일러스트. 배경은 우주, 중심 주제는 태양계 행성 '${planet}'. 과도한 왜곡 없이 특징을 보여주세요.`;
      const full = `${sys}\n행성 특징: ${planetStyle}\n사용자 요청: ${userPrompt}${styleTag}`;

      showSpinner(true);
      try{
        const result = await callOpenAIImage(full, size);
        if(result.b64){ setPreviewFromB64(result.b64); showStatus('생성이 완료되었습니다.'); }
        else if(result.url){ preview.innerHTML = `<img src="${result.url}" alt="생성된 이미지" referrerpolicy="no-referrer"/>`; showStatus('생성이 완료되었습니다.'); }
      }catch(err){ console.error(err); showStatus('오류: '+(err?.message||err),'err'); }
      finally{ showSpinner(false); }
    }

    genBtn.addEventListener('click', generate);
    promptEl.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter') generate(); });
  </script>

  <footer>© 2025 행성 일러스트 생성 데모 — 내부 전용</footer>
</body>
</html>
